<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Simulation</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- ECharts CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background: #f4f6fb;
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
        }
        .sidebar {
            background: #232946;
            min-height: 100vh;
            color: #fff;
            box-shadow: 2px 0 8px rgba(44,62,80,0.07);
        }
        .sidebar h5 {
            color: #eebbc3;
            font-weight: bold;
            margin-top: 20px;
        }
        .sidebar .nav-link {
            color: #b8c1ec;
            font-size: 1.05rem;
            border-radius: 6px;
            margin-bottom: 6px;
            transition: background 0.2s, color 0.2s;
        }
        .sidebar .nav-link.active, .sidebar .nav-link:hover {
            background: #eebbc3;
            color: #232946;
            font-weight: bold;
        }
        .card {
            border: none;
            border-radius: 14px;
            box-shadow: 0 4px 24px rgba(44,62,80,0.08);
            margin-bottom: 30px;
        }
        .card-header {
            background: #232946;
            color: #fff;
            border-radius: 14px 14px 0 0;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .nav-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: #232946;
            font-weight: 500;
            font-size: 1.08rem;
            background: none;
            transition: border-color 0.2s, color 0.2s;
        }
        .nav-tabs .nav-link.active {
            border-bottom: 3px solid #eebbc3;
            color: #eebbc3;
            background: none;
        }
        .tab-content {
            background: #fff;
            border-radius: 0 0 14px 14px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.04);
            padding: 30px 24px 24px 24px;
        }
        .table {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 0;
        }
        .table th, .table td {
            vertical-align: middle;
            border-top: none;
        }
        .table thead th {
            background: #eebbc3;
            color: #232946;
            font-weight: 600;
        }
        .progress-bar {
            background: linear-gradient(90deg, #eebbc3 0%, #b8c1ec 100%);
        }
        .code-block {
            background: #232946;
            color: #eebbc3;
            padding: 18px;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Fira Mono', 'Consolas', monospace;
            margin-bottom: 18px;
        }
        .visualization-container img {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.08);
            margin-bottom: 18px;
        }
        .result-card {
            background: #eebbc3;
            color: #232946;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.08);
            padding: 18px;
            margin-bottom: 18px;
        }
        .step-content {
            margin-bottom: 24px;
        }
        .alert-info {
            background: #b8c1ec;
            color: #232946;
            border: none;
            border-radius: 8px;
        }
        .form-control, .custom-select {
            border-radius: 6px;
            border: 1px solid #b8c1ec;
        }
        .btn-primary, .btn-success {
            background: linear-gradient(90deg, #eebbc3 0%, #b8c1ec 100%);
            color: #232946;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: background 0.2s, color 0.2s;
        }
        .btn-primary:hover, .btn-success:hover {
            background: #232946;
            color: #eebbc3;
        }
        .table-responsive {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.04);
        }
        @media (max-width: 991px) {
            .sidebar {
                min-height: auto;
            }
            .tab-content {
                padding: 18px 6px 12px 6px;
            }
        }

        pre{
            background: #232946;
            color: #eebbc3;
            padding: 18px;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Fira Mono', 'Consolas', monospace;
            margin-bottom: 18px;
        }
        
        /* Timeline and simulation styles */
        .timeline-controls {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #dee2e6;
        }
        
        .form-control-range {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #28a745 0%, #fd7e14 50%, #dc3545 100%);
            border-radius: 4px;
            outline: none;
            opacity: 0.8;
        }
        
        .form-control-range:hover {
            opacity: 1;
        }
        
        .form-control-range::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #232946;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .form-control-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #232946;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .year-info-panel {
            transition: all 0.3s ease;
        }
        
        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            font-size: 0.9rem;
        }
        
        .legend-item i {
            margin-right: 5px;
            font-size: 12px;
        }
        
        .map-legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        /* Animation for risk circles */
        .leaflet-interactive {
            transition: all 0.3s ease-in-out;
        }
        
        /* Popup custom styling */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        
        .leaflet-popup-content {
            margin: 8px 12px;
            line-height: 1.4;
        }
        
        /* Button hover effects */
        .btn-success:hover, .btn-warning:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* Timeline year display */
        #current-year-display {
            font-weight: bold;
            color: #232946;
            font-size: 1.1rem;
        }
        
        /* Real-time animation effects */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .pulse-animation {
            animation: pulse 0.8s ease-in-out 3;
        }
        
        /* Simulation indicator animation */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        #simulation-indicator {
            animation: blink 1s infinite;
        }
        
        /* Real-time visual feedback */
        .year-info-panel {
            transition: background-color 0.3s ease, opacity 0.3s ease;
        }
        
        /* Map container ensuring visibility */
        #pred-map-container {
            min-height: 500px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-none d-md-block bg-light sidebar">
                <div class="sidebar-sticky">
                    <h5>Flood Prediction</h5>
                    <hr>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/simulation">
                                Simulation
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/prediction-10-years">
                                Prediksi 10 Tahun
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/" id="trainButton" data-toggle="modal" data-target="#trainModal">
                                Training Model
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="modal" data-target="#dataLatihModal" onclick="loadDataLatih()">
                                Data Latih
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="modal" data-target="#dataUjiModal" onclick="loadDataUji()">
                                Data Uji
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="modal" data-target="#addTrainDataModal">
                                Tambah Data Latih
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="modal" data-target="#addTestDataModal">
                               Tambah Data Uji
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Model Simulation</h1>
                </div>

                <!-- Main Algorithm Tabs -->
                <ul class="nav nav-tabs" id="mainAlgorithmTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="lm-tab-link" data-toggle="tab" href="#lm-tab" role="tab" aria-controls="lm-tab" aria-selected="true">Levenberg-Marquardt (LM)</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="rnn-tab-link" data-toggle="tab" href="#rnn-tab" role="tab" aria-controls="rnn-tab" aria-selected="false">Recurrent Neural Network (RNN)</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="prediction-10-tab-link" data-toggle="tab" href="#prediction-10-tab" role="tab" aria-controls="prediction-10-tab" aria-selected="false">Prediksi 10 Tahun</a>
                    </li>
                </ul>
                <div class="tab-content" id="mainAlgorithmTabsContent">
                    <!-- LM Tab Content -->
                    <div class="tab-pane fade show active" id="lm-tab" role="tabpanel" aria-labelledby="lm-tab-link">
                        <!-- LM Step Tabs -->
                        <ul class="nav nav-tabs mt-3" id="lmStepTabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#lm-step1" role="tab">1. Parameter Input</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#lm-step2" role="tab">2. Persiapan Data</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#lm-step3" role="tab">3. Model Training</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#lm-step4" role="tab">4. Hasil & Visualisasi</a>
                            </li>
                        </ul>
                        <div class="tab-content mt-3">
                            <div class="tab-pane fade show active" id="lm-step1" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">Parameter Input</div>
                                    <div class="card-body">
                                        <form id="lmForm">
                                            <div class="form-group">
                                                <label for="lm-hidden-size">Jumlah Neuron Hidden Layer:</label>
                                                <input type="number" class="form-control" id="lm-hidden-size" value="10" min="1">
                                                <small class="form-text text-muted">Jumlah neuron pada hidden layer model.</small>
                                            </div>
                                            <div class="form-group">
                                                <label for="lm-iterations">Jumlah Iterasi:</label>
                                                <input type="number" class="form-control" id="lm-iterations" value="500" min="100">
                                                <small class="form-text text-muted">Jumlah iterasi maksimum untuk algoritma Levenberg-Marquardt.</small>
                                            </div>
                                            <div class="form-group">
                                                <label for="lm-learning-rate">Learning Rate:</label>
                                                <input type="number" class="form-control" id="lm-learning-rate" value="0.01" step="0.001" min="0.001">
                                                <small class="form-text text-muted">Kecepatan pembelajaran model.</small>
                                            </div>
                                            <button type="button" class="btn btn-primary" id="lm-run">Jalankan Simulasi LM</button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Data Preparation -->
                            <div class="tab-pane fade" id="lm-step2" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">Persiapan Data</div>
                                    <div class="card-body">
                                        <h5>Preprocessing Data</h5>
                                        <div class="code-block">
                                            <pre># Preprocessing data
le = LabelEncoder()
data['Potensi_Banjir'] = le.fit_transform(data['Potensi_Banjir'])

# Features and target
X = data[['Curah_Hujan', 'Suhu', 'Tinggi_Muka_Air']].values
y = data['Potensi_Banjir'].values
max_val = np.max(y)
y = y / max_val  # Scale target values

# Split data
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)
X_train, X_test, y_train, y_test = train_test_split(
    X_scaled, y, test_size=0.3, random_state=42)</pre>
                                        </div>
                                        <div id="lm-data-info" class="mt-4">
                                            <h5>Informasi Data</h5>
                                            <p>Menunggu simulasi dijalankan...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>                                    <!-- Step 3: Model Training -->
                            <div class="tab-pane fade" id="lm-step3" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">Model Training dengan Levenberg-Marquardt</div>
                                    <div class="card-body">
                                        <h5>Penjelasan Algoritma Levenberg-Marquardt</h5>
                                        <div class="alert alert-info">
                                            <p>Algoritma Levenberg-Marquardt (LM) adalah metode optimasi yang menggabungkan algoritma gradient descent dan Gauss-Newton untuk menyelesaikan masalah least-squares non-linear dengan cepat dan efisien. Algoritma ini digunakan untuk melatih neural network dengan menemukan parameter optimal yang meminimalkan fungsi kesalahan.</p>
                                            
                                            <p><strong>Langkah-langkah Algoritma LM:</strong></p>
                                            <ol>
                                                <li>Inisialisasi bobot neural network secara acak</li>
                                                <li>Hitung error dengan forward pass pada neural network</li>
                                                <li>Hitung Jacobian matrix (turunan partial error terhadap setiap bobot)</li>
                                                <li>Update bobot menggunakan formula LM: <code>Δw = -(J<sup>T</sup>J + λI)<sup>-1</sup>J<sup>T</sup>e</code>
                                                    <ul>
                                                        <li>J adalah Jacobian matrix</li>
                                                        <li>e adalah vektor error</li>
                                                        <li>λ adalah parameter damping (pengatur keseimbangan)</li>
                                                        <li>I adalah identity matrix</li>
                                                    </ul>
                                                </li>
                                                <li>Jika error berkurang, kurangi λ dan terima update</li>
                                                <li>Jika error meningkat, tingkatkan λ dan hitung update lagi</li>
                                                <li>Ulangi langkah 2-6 hingga konvergen</li>
                                            </ol>
                                        </div>
                                        
                                        <h5 class="mt-4">Implementasi Algoritma LM</h5>
                                        <div class="code-block">
                                            <pre># Define error function for LM algorithm
def error_function(weights, X, y):
    model.unflatten_weights(weights)
    y_hat = model.forward(X)
    return (y_hat - y).ravel()

# Initialize weights
initial_weights = model.flatten_weights()

# Run Levenberg-Marquardt optimization
optimal_weights, success = leastsq(
    error_function, initial_weights, 
    args=(X_train, y_train.reshape(-1, 1)), 
    maxfev=iterations
)

# Update model with optimal weights
model.unflatten_weights(optimal_weights)</pre>
                                        </div>
                                        
                                        <h5 class="mt-4">Keuntungan Algoritma LM</h5>
                                        <ul>
                                            <li>Konvergensi lebih cepat dibanding backpropagation standar</li>
                                            <li>Menggabungkan kelebihan gradient descent dan Gauss-Newton</li>
                                            <li>Robust terhadap masalah bad initialization</li>
                                            <li>Sangat efektif untuk masalah least-squares</li>
                                        </ul>
                                        <div id="lm-training-progress" class="mt-4">
                                            <h5>Progress Pelatihan</h5>
                                            <p>Menunggu simulasi dijalankan...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Results & Visualization -->
                            <div class="tab-pane fade" id="lm-step4" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">Hasil dan Visualisasi</div>
                                    <div class="card-body">
                                        <div id="lm-metrics" class="mb-4">
                                            <h5>Metrik Evaluasi</h5>
                                            <p>Menunggu simulasi dijalankan...</p>
                                        </div>                                                <div class="row visualization-container">
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">Grafik Loss</div>
                                                    <div class="card-body">
                                                        <div id="lm-loss-plot">
                                                            <p>Menunggu simulasi dijalankan...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">Visualisasi t-SNE</div>
                                                    <div class="card-body">
                                                        <div id="lm-tsne-plot">
                                                            <p>Menunggu simulasi dijalankan...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-4 visualization-container">
                                            <div class="col-md-12">
                                                <div class="card">
                                                    <div class="card-header">Distribusi Fitur berdasarkan Potensi Banjir</div>
                                                    <div class="card-body">
                                                        <div id="lm-dist-plot">
                                                            <p>Menunggu simulasi dijalankan...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row mt-4 visualization-container">
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">Confusion Matrix</div>
                                                    <div class="card-body">
                                                        <div id="lm-cm-plot">
                                                            <p>Menunggu simulasi dijalankan...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">Pemetaan Hasil Prediksi</div>
                                                    <div class="card-body">
                                                        <div id="lm-map-container">
                                                            <p>Menunggu simulasi dijalankan...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RNN Tab Content -->
                    <div class="tab-pane fade" id="rnn-tab" role="tabpanel" aria-labelledby="rnn-tab-link">
                        <!-- RNN Step Tabs -->
                        <ul class="nav nav-tabs mt-3" id="rnnStepTabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#rnn-step1" role="tab">1. Parameter Input</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#rnn-step2" role="tab">2. Persiapan Data</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#rnn-step3" role="tab">3. Model Training</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#rnn-step4" role="tab">4. Hasil & Visualisasi</a>
                            </li>
                        </ul>
                        <div class="tab-content mt-3">
                            <div class="tab-pane fade show active" id="rnn-step1" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">Parameter Input</div>
                                    <div class="card-body">
                                        <form id="rnnForm">
                                            <div class="form-group">
                                                <label for="rnn-hidden-size">Jumlah Neuron Hidden Layer:</label>
                                                <input type="number" class="form-control" id="rnn-hidden-size" value="32" min="1">
                                                <small class="form-text text-muted">Jumlah neuron pada hidden layer model RNN.</small>
                                            </div>
                                            <div class="form-group">
                                                <label for="rnn-epochs">Jumlah Epochs:</label>
                                                <input type="number" class="form-control" id="rnn-epochs" value="100" min="10">
                                                <small class="form-text text-muted">Jumlah epochs untuk melatih model RNN.</small>
                                            </div>
                                            <div class="form-group">
                                                <label for="rnn-learning-rate">Learning Rate:</label>
                                                <input type="number" class="form-control" id="rnn-learning-rate" value="0.01" step="0.001" min="0.001">
                                                <small class="form-text text-muted">Kecepatan pembelajaran model.</small>
                                            </div>
                                            <div class="form-group">
                                                <label for="rnn-batch-size">Batch Size:</label>
                                                <input type="number" class="form-control" id="rnn-batch-size" value="16" min="1">
                                                <small class="form-text text-muted">Ukuran batch dalam satu iterasi.</small>
                                            </div>
                                            <button type="button" class="btn btn-primary" id="rnn-run">Jalankan Simulasi RNN</button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Data Preparation -->
                            <div class="tab-pane fade" id="rnn-step2" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">Persiapan Data</div>
                                    <div class="card-body">
                                        <h5>Preprocessing Data</h5>
                                        <div class="code-block">
                                            <pre># Convert to PyTorch tensors
X_train_tensor = torch.FloatTensor(X_train).unsqueeze(1)  # Add sequence dimension
y_train_tensor = torch.FloatTensor(y_train).unsqueeze(1)
X_test_tensor = torch.FloatTensor(X_test).unsqueeze(1)
y_test_tensor = torch.FloatTensor(y_test).unsqueeze(1)</pre>
                                        </div>
                                        <div id="rnn-data-info" class="mt-4">
                                            <h5>Informasi Data</h5>
                                            <p>Menunggu simulasi dijalankan...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>                                    <!-- Step 3: Model Training -->
                            <div class="tab-pane fade" id="rnn-step3" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">Model Training dengan RNN</div>
                                    <div class="card-body">
                                        <h5>Penjelasan Algoritma Recurrent Neural Network (RNN)</h5>
                                        <div class="alert alert-info">
                                            <p>Recurrent Neural Network (RNN) adalah jenis neural network yang dirancang untuk memproses data sekuensial dengan mempertahankan "state" atau "memory" dari input sebelumnya. Ini sangat berguna untuk prediksi data time-series seperti data banjir.</p>
                                            
                                            <p><strong>Cara Kerja RNN:</strong></p>
                                            <ol>
                                                <li>RNN memiliki loop internal yang memungkinkan informasi bertahan</li>
                                                <li>Pada setiap langkah waktu t, RNN menerima input x<sub>t</sub> dan state sebelumnya h<sub>t-1</sub></li>
                                                <li>State baru diperbarui: h<sub>t</sub> = tanh(W<sub>h</sub>h<sub>t-1</sub> + W<sub>x</sub>x<sub>t</sub> + b)</li>
                                                <li>Output dihitung: y<sub>t</sub> = W<sub>y</sub>h<sub>t</sub> + b<sub>y</sub></li>
                                                <li>Bobot W diperbarui menggunakan Backpropagation Through Time (BPTT)</li>
                                            </ol>
                                            
                                            <p><strong>Keunggulan RNN:</strong></p>
                                            <ul>
                                                <li>Dapat menangkap pola temporal dalam data</li>
                                                <li>Mempertimbangkan konteks historis, cocok untuk prediksi banjir yang dipengaruhi oleh pola cuaca sebelumnya</li>
                                                <li>Fleksibel untuk input dengan panjang bervariasi</li>
                                            </ul>
                                        </div>
                                        
                                        <h5 class="mt-4">Arsitektur Model RNN</h5>
                                        <div class="code-block">
                                            <pre>class RNNModel(nn.Module):
    def __init__(self, input_size, hidden_size, output_size):
        super(RNNModel, self).__init__()
        self.hidden_size = hidden_size
        self.rnn = nn.RNN(input_size, hidden_size, batch_first=True)
        self.fc = nn.Linear(hidden_size, output_size)
        
    def forward(self, x):
        batch_size = x.size(0)
        h0 = torch.zeros(1, batch_size, self.hidden_size).to(x.device)
        out, _ = self.rnn(x, h0)
        out = self.fc(out[:, -1, :])
        return out</pre>
                                        </div>
                                        
                                        <h5 class="mt-4">Proses Training RNN</h5>
                                        <div class="code-block">
                                            <pre># Training loop
for epoch in range(1, epochs + 1):
    # Training
    model.train()
    optimizer.zero_grad()
    outputs = model(X_train_tensor)
    loss = criterion(outputs, y_train_tensor)
    loss.backward()
    optimizer.step()
    
    # Log metrics every step_size epochs
    if epoch % step_size == 0 or epoch == epochs:
        model.eval()
        with torch.no_grad():
            train_outputs = model(X_train_tensor)
            test_outputs = model(X_test_tensor)
            train_loss = criterion(train_outputs, y_train_tensor).item()
            test_loss = criterion(test_outputs, y_test_tensor).item()</pre>
                                        </div>
                                        
                                        <div id="rnn-training-progress" class="mt-4">
                                            <h5>Progress Pelatihan</h5>
                                            <p>Menunggu simulasi dijalankan...</p>
                                        </div>
                                        <div id="rnn-epoch-table" class="mt-4">
                                            <h5>Tabel Progress Epoch</h5>
                                            <p>Menunggu simulasi dijalankan...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Results & Visualization -->
                            <div class="tab-pane fade" id="rnn-step4" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">Hasil dan Visualisasi</div>
                                    <div class="card-body">
                                        <div id="rnn-metrics" class="mb-4">
                                            <h5>Metrik Evaluasi</h5>
                                            <p>Menunggu simulasi dijalankan...</p>
                                        </div>                                                <div class="row visualization-container">
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">Grafik Loss</div>
                                                    <div class="card-body">
                                                        <div id="rnn-loss-plot">
                                                            <p>Menunggu simulasi dijalankan...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">Visualisasi t-SNE</div>
                                                    <div class="card-body">
                                                        <div id="rnn-tsne-plot">
                                                            <p>Menunggu simulasi dijalankan...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-4 visualization-container">
                                            <div class="col-md-12">
                                                <div class="card">
                                                    <div class="card-header">Distribusi Fitur berdasarkan Potensi Banjir</div>
                                                    <div class="card-body">
                                                        <div id="rnn-dist-plot">
                                                            <p>Menunggu simulasi dijalankan...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row mt-4 visualization-container">
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">Confusion Matrix</div>
                                                    <div class="card-body">
                                                        <div id="rnn-cm-plot">
                                                            <p>Menunggu simulasi dijalankan...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">Pemetaan Hasil Prediksi</div>
                                                    <div class="card-body">
                                                        <div id="rnn-map-container">
                                                            <p>Menunggu simulasi dijalankan...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>                                            </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prediction 10 Years Tab Content -->
                    <div class="tab-pane fade" id="prediction-10-tab" role="tabpanel" aria-labelledby="prediction-10-tab-link">
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>Parameter Prediksi 10 Tahun</h5>
                            </div>
                            <div class="card-body">
                                <form id="prediction10Form">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="pred-start-year">Tahun Mulai:</label>
                                                <select class="form-control" id="pred-start-year">
                                                    <option value="2024">2024</option>
                                                    <option value="2025">2025</option>
                                                    <option value="2026">2026</option>
                                                    <option value="2027">2027</option>
                                                    <option value="2028">2028</option>
                                                </select>
                                                <small class="form-text text-muted">Tahun awal untuk memulai prediksi.</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="pred-region">Wilayah:</label>
                                                <select class="form-control" id="pred-region">
                                                    <option value="Langkahan" selected>Langkahan (Rekomendasi)</option>
                                                    <option value="Baktiya">Baktiya</option>
                                                    <option value="Lhoksukon">Lhoksukon</option>
                                                    <option value="Cot Girek">Cot Girek</option>
                                                    <option value="Matangkuli">Matangkuli</option>
                                                    <option value="Tanah Luas">Tanah Luas</option>
                                                    <option value="Stamet Aceh Utara">Stamet Aceh Utara</option>
                                                </select>
                                                <small class="form-text text-muted">Langkahan dipilih sebagai wilayah fokus simulasi interaktif.</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="pred-scenario">Skenario Iklim:</label>
                                                <select class="form-control" id="pred-scenario">
                                                    <option value="normal">Normal</option>
                                                    <option value="optimistic">Optimis</option>
                                                    <option value="pessimistic">Pesimis</option>
                                                </select>
                                                <small class="form-text text-muted">Skenario perubahan iklim untuk prediksi.</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-info">
                                        <h6>Penjelasan Skenario:</h6>
                                        <ul class="mb-0">
                                            <li><strong>Normal:</strong> Perubahan iklim moderat (curah hujan +2%/tahun, suhu +0.05°C/tahun)</li>
                                            <li><strong>Optimis:</strong> Kondisi iklim membaik (curah hujan -1%/tahun, suhu +0.02°C/tahun)</li>
                                            <li><strong>Pesimis:</strong> Perubahan iklim ekstrem (curah hujan +5%/tahun, suhu +0.1°C/tahun)</li>
                                        </ul>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-lg" id="pred-run">
                                        <i class="fas fa-chart-line"></i> Jalankan Prediksi 10 Tahun
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Results Section for 10 Years Prediction -->
                        <div id="pred-results-section" style="display: none;">
                            
                            <!-- Summary Cards -->
                            <div class="row" id="pred-summary-cards" style="margin-top: 20px;">
                                <!-- Summary cards will be populated here -->
                            </div>

                            <!-- Trend Analysis -->
                            <div class="card">
                                <div class="card-header">
                                    <h5>Analisis Trend 10 Tahun</h5>
                                </div>
                                <div class="card-body">
                                    <div id="pred-trend-analysis">
                                        <!-- Trend analysis will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Charts -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>Grafik Trend Risiko Tahunan</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="pred-chart-container">
                                                <!-- Chart will be rendered here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Interactive Map with Timeline -->
                            <div class="card">
                                <div class="card-header">
                                    <h5>Simulasi Banjir Bertahap - Prediksi 10 Tahun</h5>
                                </div>
                                <div class="card-body">
                                    <!-- Timeline Controls -->
                                    <div class="timeline-controls mb-3" id="timeline-controls" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <label for="year-slider">Tahun Simulasi:</label>
                                                <input type="range" class="form-control-range" id="year-slider" min="0" max="9" value="0" step="1">
                                                <div class="d-flex justify-content-between">
                                                    <small id="start-year">2024</small>
                                                    <small id="current-year-display">2024</small>
                                                    <small id="end-year">2033</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <button class="btn btn-success btn-sm" id="play-simulation">
                                                    <i class="fas fa-play"></i> Play Simulasi
                                                </button>
                                                <button class="btn btn-warning btn-sm" id="pause-simulation" style="display: none;">
                                                    <i class="fas fa-pause"></i> Pause
                                                </button>
                                                <button class="btn btn-secondary btn-sm" id="reset-simulation">
                                                    <i class="fas fa-refresh"></i> Reset
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Year Info Panel -->
                                        <div class="year-info-panel mt-3 p-3" style="background: #f8f9fa; border-radius: 8px;">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <strong>Tahun: <span id="info-year">2024</span></strong>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Rata-rata Risiko: <span id="info-risk">-</span></strong>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Status: <span id="info-status">-</span></strong>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Bulan Berisiko: <span id="info-risky-months">-</span></strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Map Container -->
                                    <div id="pred-map-container" style="height: 500px; border-radius: 8px;">
                                        <!-- Leaflet map will be rendered here -->
                                    </div>
                                    
                                    <!-- Legend -->
                                    <div class="map-legend mt-3">
                                        <h6>Legenda Risiko Banjir:</h6>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <span class="legend-item">
                                                    <i class="fas fa-circle" style="color: #28a745;"></i> Aman (0)
                                                </span>
                                            </div>
                                            <div class="col-md-3">
                                                <span class="legend-item">
                                                    <i class="fas fa-circle" style="color: #007bff;"></i> Waspada (1)
                                                </span>
                                            </div>
                                            <div class="col-md-3">
                                                <span class="legend-item">
                                                    <i class="fas fa-circle" style="color: #fd7e14;"></i> Siaga (2)
                                                </span>
                                            </div>
                                            <div class="col-md-3">
                                                <span class="legend-item">
                                                    <i class="fas fa-circle" style="color: #dc3545;"></i> Awas (3)
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Yearly Summary -->
                            <div class="card">
                                <div class="card-header">
                                    <h5>Ringkasan Tahunan</h5>
                                </div>
                                <div class="card-body">
                                    <div id="pred-yearly-summary">
                                        <!-- Yearly summary will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Detailed Table -->
                            <div class="card">
                                <div class="card-header">
                                    <h5>Data Prediksi Lengkap (Sample)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 400px;">
                                        <table class="table table-striped table-hover" id="pred-predictions-table">
                                            <thead class="thead-dark">
                                                <tr>
                                                    <th>Tahun</th>
                                                    <th>Bulan</th>
                                                    <th>Curah Hujan (mm)</th>
                                                    <th>Suhu (°C)</th>
                                                    <th>Tinggi Air (cm)</th>
                                                    <th>Prediksi</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Table data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // Wait for DOM to be ready
        $(document).ready(function() {
            // Handle LM Run Button
            $('#lm-run').click(function() {
                const hiddenSize = parseInt($('#lm-hidden-size').val());
                const iterations = parseInt($('#lm-iterations').val());
                const learningRate = parseFloat($('#lm-learning-rate').val());
                
                // Show loading state
                $('#lm-run').prop('disabled', true);
                $('#lm-run').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Simulasi sedang berjalan...');
                
                // Call the server
                $.ajax({
                    url: '/simulate_lm',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        hidden_size: hiddenSize,
                        iterations: iterations,
                        learning_rate: learningRate
                    }),
                    success: function(response) {
                        // Update step tabs
                        $('#lmStepTabs a[href="#lm-step2"]').tab('show');
                          // Update data info
                        const dataInfo = `
                            <h5>Informasi Data</h5>
                            <table class="table table-bordered">
                                <tr>
                                    <th>Fitur</th>
                                    <td>Curah Hujan, Suhu, Tinggi Muka Air</td>
                                </tr>
                                <tr>
                                    <th>Target</th>
                                    <td>Potensi Banjir (0-3)</td>
                                </tr>
                                <tr>
                                    <th>Total Data Latih</th>
                                    <td>${response.data_stats.train_count} records (dari database)</td>
                                </tr>
                                <tr>
                                    <th>Total Data Uji</th>
                                    <td>${response.data_stats.test_count} records (dari database)</td>
                                </tr>
                                <tr>
                                    <th>Training Set</th>
                                    <td>70%</td>
                                </tr>
                                <tr>
                                    <th>Testing Set</th>
                                    <td>30%</td>
                                </tr>
                                <tr>
                                    <th>Database</th>
                                    <td>MySQL - data_banjir (tabel: data_banjir, data_uji)</td>
                                </tr>
                            </table>
                        `;
                        $('#lm-data-info').html(dataInfo);
                        
                        // After 2 seconds, move to next step
                        setTimeout(function() {
                            $('#lmStepTabs a[href="#lm-step3"]').tab('show');
                            
                            // Update training progress
                            const trainingInfo = `
                                <h5>Progress Pelatihan</h5>
                                <div class="progress mb-3">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>
                                </div>
                                <p>Algoritma LM telah menyelesaikan ${iterations} iterasi.</p>
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Metrik</th>
                                            <th>Nilai</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Train Loss</td>
                                            <td>${response.metrics.train_mse.toFixed(4)}</td>
                                        </tr>
                                        <tr>
                                            <td>Test Loss</td>
                                            <td>${response.metrics.test_mse.toFixed(4)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                            $('#lm-training-progress').html(trainingInfo);
                            
                            // After 2 more seconds, show results
                            setTimeout(function() {
                                $('#lmStepTabs a[href="#lm-step4"]').tab('show');
                                
                                // Update metrics
                                const metricsHtml = `
                                    <h5>Metrik Evaluasi</h5>
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Metrik</th>
                                                <th>Training</th>
                                                <th>Testing</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Mean Squared Error</td>
                                                <td>${response.metrics.train_mse.toFixed(4)}</td>
                                                <td>${response.metrics.test_mse.toFixed(4)}</td>
                                            </tr>
                                            <tr>
                                                <td>Accuracy</td>
                                                <td>${(response.metrics.train_acc * 100).toFixed(2)}%</td>
                                                <td>${(response.metrics.test_acc * 100).toFixed(2)}%</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                                $('#lm-metrics').html(metricsHtml);
                                  // Update plots
                                $('#lm-loss-plot').html(`<img src="data:image/png;base64,${response.visualizations.loss_plot}" alt="Loss Plot" class="img-fluid">`);
                                $('#lm-tsne-plot').html(`<img src="data:image/png;base64,${response.visualizations.tsne_plot}" alt="t-SNE Plot" class="img-fluid">`);
                                $('#lm-cm-plot').html(`<img src="data:image/png;base64,${response.visualizations.confusion_matrix}" alt="Confusion Matrix" class="img-fluid">`);
                                $('#lm-dist-plot').html(`<img src="data:image/png;base64,${response.visualizations.distribution_plot}" alt="Distribution Plot" class="img-fluid">`);
                                $('#lm-map-container').html(response.visualizations.map_html);
                                
                                // Reset button
                                $('#lm-run').prop('disabled', false);
                                $('#lm-run').html('Jalankan Simulasi LM');
                            }, 2000);
                        }, 2000);
                    },
                    error: function(error) {
                        alert('Error: ' + error.responseText);
                        $('#lm-run').prop('disabled', false);
                        $('#lm-run').html('Jalankan Simulasi LM');
                    }
                });
            });
            
            // Handle RNN Run Button
            $('#rnn-run').click(function() {
                const hiddenSize = parseInt($('#rnn-hidden-size').val());
                const epochs = parseInt($('#rnn-epochs').val());
                const learningRate = parseFloat($('#rnn-learning-rate').val());
                const batchSize = parseInt($('#rnn-batch-size').val());
                
                // Show loading state
                $('#rnn-run').prop('disabled', true);
                $('#rnn-run').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Simulasi sedang berjalan...');
                
                // Call the server
                $.ajax({
                    url: '/simulate_rnn',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        hidden_size: hiddenSize,
                        epochs: epochs,
                        learning_rate: learningRate,
                        batch_size: batchSize
                    }),
                    success: function(response) {
                        // Update step tabs
                        $('#rnnStepTabs a[href="#rnn-step2"]').tab('show');
                        
                        // Update data info
                        const dataInfo = `
                            <h5>Informasi Data</h5>
                            <table class="table table-bordered">
                                <tr>
                                    <th>Fitur</th>
                                    <td>Curah Hujan, Suhu, Tinggi Muka Air</td>
                                </tr>
                                <tr>
                                    <th>Target</th>
                                    <td>Potensi Banjir (0-3)</td>
                                </tr>
                                <tr>
                                    <th>Jumlah Data</th>
                                    <td>Hasil perhitungan dari database</td>
                                </tr>
                                <tr>
                                    <th>Training Set</th>
                                    <td>70%</td>
                                </tr>
                                <tr>
                                    <th>Testing Set</th>
                                    <td>30%</td>
                                </tr>
                                <tr>
                                    <th>Format Input</th>
                                    <td>Tensor 3D untuk RNN (batch_size, seq_len, input_size)</td>
                                </tr>
                            </table>
                        `;
                        $('#rnn-data-info').html(dataInfo);
                        
                        // After 2 seconds, move to next step
                        setTimeout(function() {
                            $('#rnnStepTabs a[href="#rnn-step3"]').tab('show');
                            
                            // Update training progress
                            const trainingInfo = `
                                <h5>Progress Pelatihan</h5>
                                <div class="progress mb-3">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>
                                </div>
                                <p>RNN telah menyelesaikan ${epochs} epoch.</p>
                            `;
                            $('#rnn-training-progress').html(trainingInfo);
                            
                            // Create epoch table
                            let tableHtml = `
                                <h5>Tabel Progress Epoch</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped">
                                        <thead>
                                            <tr>
                                                <th>Epoch</th>
                                                <th>Train Loss</th>
                                                <th>Test Loss</th>
                                                <th>Train Acc</th>
                                                <th>Test Acc</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            // Only show a few representative epochs to keep table manageable
                            const epochsToShow = response.epoch_data.filter((item, index, array) => 
                                index === 0 || index === array.length - 1 || index % Math.max(1, Math.floor(array.length / 10)) === 0
                            );
                            
                            for (let epochData of epochsToShow) {
                                tableHtml += `
                                    <tr>
                                        <td>${epochData.epoch}</td>
                                        <td>${epochData.train_loss.toFixed(4)}</td>
                                        <td>${epochData.test_loss.toFixed(4)}</td>
                                        <td>${(epochData.train_acc * 100).toFixed(2)}%</td>
                                        <td>${(epochData.test_acc * 100).toFixed(2)}%</td>
                                    </tr>
                                `;
                            }
                            
                            tableHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            
                            $('#rnn-epoch-table').html(tableHtml);
                            
                            // After 2 more seconds, show results
                            setTimeout(function() {
                                $('#rnnStepTabs a[href="#rnn-step4"]').tab('show');
                                
                                // Update metrics
                                const metricsHtml = `
                                    <h5>Metrik Evaluasi</h5>
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Metrik</th>
                                                <th>Training</th>
                                                <th>Testing</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Mean Squared Error</td>
                                                <td>${response.metrics.train_mse.toFixed(4)}</td>
                                                <td>${response.metrics.test_mse.toFixed(4)}</td>
                                            </tr>
                                            <tr>
                                                <td>Accuracy</td>
                                                <td>${(response.metrics.train_acc * 100).toFixed(2)}%</td>
                                                <td>${(response.metrics.test_acc * 100).toFixed(2)}%</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                                $('#rnn-metrics').html(metricsHtml);
                                  // Update plots
                                $('#rnn-loss-plot').html(`<img src="data:image/png;base64,${response.visualizations.loss_plot}" alt="Loss Plot" class="img-fluid">`);
                                $('#rnn-tsne-plot').html(`<img src="data:image/png;base64,${response.visualizations.tsne_plot}" alt="t-SNE Plot" class="img-fluid">`);
                                $('#rnn-cm-plot').html(`<img src="data:image/png;base64,${response.visualizations.confusion_matrix}" alt="Confusion Matrix" class="img-fluid">`);
                                $('#rnn-dist-plot').html(`<img src="data:image/png;base64,${response.visualizations.distribution_plot}" alt="Distribution Plot" class="img-fluid">`);
                                $('#rnn-map-container').html(response.visualizations.map_html);
                                
                                // Reset button
                                $('#rnn-run').prop('disabled', false);
                                $('#rnn-run').html('Jalankan Simulasi RNN');
                            }, 2000);
                        }, 2000);
                    },
                    error: function(error) {
                        alert('Error: ' + error.responseText);
                        $('#rnn-run').prop('disabled', false);
                        $('#rnn-run').html('Jalankan Simulasi RNN');
                    }
                });
            });
            
            // Handle 10 Years Prediction Run Button
            $('#pred-run').click(function() {
                const startYear = parseInt($('#pred-start-year').val());
                const region = $('#pred-region').val();
                const scenario = $('#pred-scenario').val();
                
                // Show loading state
                $('#pred-run').prop('disabled', true);
                $('#pred-run').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menghitung prediksi...');
                
                // Call the prediction API
                $.ajax({
                    url: '/simulate_10_years',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        start_year: startYear,
                        region: region,
                        scenario: scenario
                    }),
                    success: function(response) {
                        displayPredictionResults(response);
                        $('#pred-results-section').show();
                    },
                    error: function(xhr, status, error) {
                        let errorMsg = 'Terjadi kesalahan saat menjalankan prediksi.';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        alert('Error: ' + errorMsg);
                    },
                    complete: function() {
                        $('#pred-run').prop('disabled', false);
                        $('#pred-run').html('<i class="fas fa-chart-line"></i> Jalankan Prediksi 10 Tahun');
                    }
                });
            });
            
            // Update sidebar with active link
            $('.sidebar .nav-link').removeClass('active');
            $('.sidebar .nav-link[href="/simulation"]').addClass('active');
        });
        
        // Function to display 10 years prediction results
        function displayPredictionResults(data) {
            // Display summary cards
            displayPredSummaryCards(data);
            
            // Display trend analysis
            displayPredTrendAnalysis(data.trend_analysis);
            
            // Display chart
            displayPredChart(data.chart_data);
            
            // Initialize interactive map with simulation
            displayPredMap(data.region, data.coordinates);
            
            // Initialize simulation controls and data
            initializeSimulation(data);
            
            // Display yearly summary
            displayPredYearlySummary(data.yearly_summary);
            
            // Display sample data in table (first 24 months)
            displayPredTable(data.predictions.slice(0, 24));
        }

        function displayPredSummaryCards(data) {
            const summaryData = data.yearly_summary;
            const avgRisk = (summaryData.reduce((sum, year) => sum + year.rata_rata_risiko, 0) / summaryData.length).toFixed(2);
            const criticalYears = data.trend_analysis.critical_years.length;
            const safeYears = data.trend_analysis.safe_years.length;

            const cardsHtml = `
                <div class="col-md-3">
                    <div class="result-card text-center">
                        <h3>${avgRisk}</h3>
                        <p><strong>Rata-rata Risiko</strong></p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="result-card text-center">
                        <h3>${criticalYears}</h3>
                        <p><strong>Tahun Kritis</strong></p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="result-card text-center">
                        <h3>${safeYears}</h3>
                        <p><strong>Tahun Aman</strong></p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="result-card text-center">
                        <h3>${data.trend_analysis.trend_direction}</h3>
                        <p><strong>Trend Risiko</strong></p>
                    </div>
                </div>
            `;
            
            $('#pred-summary-cards').html(cardsHtml);
        }

        function displayPredTrendAnalysis(trendData) {
            const analysisHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Trend Umum:</h6>
                        <p>Risiko banjir menunjukkan trend <strong>${trendData.trend_direction}</strong>
                        dengan perubahan sebesar <strong>${trendData.risk_increase}%</strong> selama 10 tahun.</p>
                        
                        <h6>Tahun Kritis:</h6>
                        ${trendData.critical_years.length > 0 ?
                            `<p>Tahun dengan risiko tinggi: <strong>${trendData.critical_years.join(', ')}</strong></p>` :
                            '<p>Tidak ada tahun dengan risiko kritis yang teridentifikasi.</p>'
                        }
                    </div>
                    <div class="col-md-6">
                        <h6>Tahun Aman:</h6>
                        ${trendData.safe_years.length > 0 ?
                            `<p>Tahun dengan risiko rendah: <strong>${trendData.safe_years.join(', ')}</strong></p>` :
                            '<p>Tidak ada tahun dengan risiko rendah yang teridentifikasi.</p>'
                        }
                        
                        <h6>Rekomendasi:</h6>
                        <p>Monitoring intensif diperlukan terutama pada tahun-tahun kritis.
                        Persiapan mitigasi bencana sebaiknya diperkuat menjelang periode tersebut.</p>
                    </div>
                </div>
            `;
            
            $('#pred-trend-analysis').html(analysisHtml);
        }

        function displayPredChart(chartData) {
            // Create a simple text-based chart visualization
            let chartHtml = `
                <div class="alert alert-info">
                    <h6>Trend Risiko 10 Tahun:</h6>
                    <div class="row">
            `;
            
            if (chartData.years && chartData.avg_risks) {
                for (let i = 0; i < chartData.years.length; i++) {
                    const year = chartData.years[i];
                    const risk = chartData.avg_risks[i];
                    const maxRisk = chartData.max_risks[i];
                    
                    chartHtml += `
                        <div class="col-md-6 mb-2">
                            <strong>${year}:</strong>
                            Rata-rata: ${risk.toFixed(2)} |
                            Maksimum: ${maxRisk}
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar" role="progressbar"
                                     style="width: ${(risk/3)*100}%; background-color: ${risk < 1 ? '#28a745' : risk < 2 ? '#007bff' : risk < 3 ? '#fd7e14' : '#dc3545'}"
                                     aria-valuenow="${risk}" aria-valuemin="0" aria-valuemax="3">
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            chartHtml += `
                    </div>
                </div>
            `;
            
            $('#pred-chart-container').html(chartHtml);
        }

        // Global variables for map simulation
        let predictionMap;
        let simulationData = null;
        let currentYearIndex = 0;
        let simulationInterval = null;
        let regionMarker = null;
        let riskCircle = null;
        let isMapInitialized = false;

        function displayPredMap(region, coordinates) {
            console.log('Initializing map for region:', region, 'coordinates:', coordinates);
            
            // Clear existing map
            if (predictionMap) {
                predictionMap.remove();
                predictionMap = null;
            }
            
            // Ensure container exists and is visible
            const mapContainer = document.getElementById('pred-map-container');
            if (!mapContainer) {
                console.error('Map container not found!');
                return;
            }
            
            // Clear container
            mapContainer.innerHTML = '';
            
            // Center map on the selected region (default to Langkahan)
            const mapCenter = coordinates && coordinates[0] !== 0 ? coordinates : [4.9211586, 97.1261701];
            
            // Wait a bit for container to be ready
            setTimeout(() => {
                try {
                    // Initialize Leaflet map
                    predictionMap = L.map('pred-map-container', {
                        center: mapCenter,
                        zoom: 13,
                        zoomControl: true,
                        scrollWheelZoom: true
                    });
                    
                    // Add tile layer with error handling
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 18
                    }).addTo(predictionMap);
                    
                    // Add initial marker for the region
                    regionMarker = L.marker(mapCenter, {
                        title: region,
                        draggable: false
                    }).addTo(predictionMap);
                    
                    // Set initial popup
                    regionMarker.bindPopup(`
                        <div style="text-align: center; min-width: 200px;">
                            <h6><strong>${region}</strong></h6>
                            <p>Koordinat: ${mapCenter[0].toFixed(6)}, ${mapCenter[1].toFixed(6)}</p>
                            <small>Menunggu data prediksi...</small>
                        </div>
                    `);
                    
                    isMapInitialized = true;
                    console.log('Map initialized successfully');
                    
                    // Force map to resize
                    setTimeout(() => {
                        predictionMap.invalidateSize();
                    }, 100);
                    
                } catch (error) {
                    console.error('Error initializing map:', error);
                    // Fallback to simple HTML
                    mapContainer.innerHTML = `
                        <div class="text-center p-4" style="background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; height: 100%;">
                            <h5>${region}</h5>
                            <p>Koordinat: ${mapCenter[0]}, ${mapCenter[1]}</p>
                            <p><i class="fas fa-map-marker-alt" style="font-size: 48px; color: #eebbc3;"></i></p>
                            <small>Peta akan dimuat setelah prediksi selesai</small>
                        </div>
                    `;
                }
            }, 100);
        }

        function initializeSimulation(data) {
            console.log('Initializing simulation with data:', data);
            simulationData = data;
            
            if (!data.yearly_summary || data.yearly_summary.length === 0) {
                console.error('No yearly summary data available');
                return;
            }
            
            const startYear = data.yearly_summary[0].tahun;
            const endYear = data.yearly_summary[data.yearly_summary.length - 1].tahun;
            
            // Update timeline controls
            $('#start-year').text(startYear);
            $('#end-year').text(endYear);
            $('#current-year-display').text(startYear);
            $('#info-year').text(startYear);
            
            // Setup slider range
            $('#year-slider').attr('max', data.yearly_summary.length - 1);
            $('#year-slider').val(0);
            
            // Setup event listeners with immediate feedback
            $('#year-slider').off('input').on('input', function() {
                currentYearIndex = parseInt($(this).val());
                updateMapForYear(currentYearIndex);
                updateYearInfo(currentYearIndex);
                
                // Real-time feedback
                const currentYear = data.yearly_summary[currentYearIndex].tahun;
                $('#current-year-display').text(currentYear);
            });
            
            $('#play-simulation').off('click').on('click', startSimulation);
            $('#pause-simulation').off('click').on('click', pauseSimulation);
            $('#reset-simulation').off('click').on('click', resetSimulation);
            
            // Wait for map to be ready, then initialize
            const waitForMap = () => {
                if (isMapInitialized && predictionMap) {
                    console.log('Map is ready, updating with first year data');
                    currentYearIndex = 0;
                    updateMapForYear(0);
                    updateYearInfo(0);
                    $('#timeline-controls').fadeIn(500);
                } else {
                    console.log('Waiting for map to be ready...');
                    setTimeout(waitForMap, 200);
                }
            };
            
            waitForMap();
        }

        function updateMapForYear(yearIndex) {
            console.log('Updating map for year index:', yearIndex);
            
            if (!simulationData || !simulationData.yearly_summary[yearIndex]) {
                console.error('No data for year index:', yearIndex);
                return;
            }
            
            if (!predictionMap || !isMapInitialized) {
                console.log('Map not ready, skipping update');
                return;
            }
            
            const yearData = simulationData.yearly_summary[yearIndex];
            const region = simulationData.region;
            const coordinates = simulationData.coordinates || [4.9211586, 97.1261701];
            
            console.log('Updating year:', yearData.tahun, 'risk:', yearData.tingkat_risiko);
            
            // Update slider position and display (real-time)
            $('#year-slider').val(yearIndex);
            $('#current-year-display').text(yearData.tahun);
            
            // Remove existing risk circle with fade effect
            if (riskCircle) {
                riskCircle.setStyle({ fillOpacity: 0, opacity: 0 });
                setTimeout(() => {
                    if (riskCircle && predictionMap) {
                        predictionMap.removeLayer(riskCircle);
                        riskCircle = null;
                    }
                }, 150);
            }
            
            // Color mapping based on risk level (real-time colors)
            const riskColors = {
                'Rendah': '#28a745',   // Green
                'Sedang': '#fd7e14',   // Orange
                'Tinggi': '#dc3545'    // Red
            };
            
            const riskColor = riskColors[yearData.tingkat_risiko] || '#6c757d';
            
            // Calculate dynamic radius based on risk (real-time sizing)
            const baseRadius = 800;
            const riskMultiplier = Math.max(0.5, yearData.rata_rata_risiko);
            const riskRadius = baseRadius + (riskMultiplier * 400);
            
            // Add new risk circle with smooth animation
            setTimeout(() => {
                if (predictionMap && isMapInitialized) {
                    riskCircle = L.circle(coordinates, {
                        color: riskColor,
                        fillColor: riskColor,
                        fillOpacity: 0,
                        opacity: 0,
                        radius: riskRadius,
                        weight: 3
                    }).addTo(predictionMap);
                    
                    // Animate circle appearance (real-time effect)
                    let opacity = 0;
                    const animateCircle = () => {
                        opacity += 0.05;
                        if (opacity <= 0.4 && riskCircle) {
                            riskCircle.setStyle({
                                fillOpacity: opacity,
                                opacity: Math.min(opacity * 2, 0.8)
                            });
                            requestAnimationFrame(animateCircle);
                        }
                    };
                    requestAnimationFrame(animateCircle);
                }
            }, 100);
            
            // Get region information for enhanced popup
            const regionInfo = simulationData.region_info || {};
            
            // Update marker popup with real-time data
            const popupContent = `
                <div style="text-align: center; min-width: 280px;">
                    <h6><strong>${region}</strong></h6>
                    <small style="color: #6c757d;">${regionInfo.description || 'Simulasi Prediksi Banjir'}</small>
                    <hr style="margin: 8px 0;">
                    <div style="text-align: left;">
                        <strong>📅 Tahun:</strong> ${yearData.tahun}<br>
                        <strong>📍 Koordinat:</strong> ${coordinates[0].toFixed(6)}, ${coordinates[1].toFixed(6)}<br>
                        <strong>📊 Rata-rata Risiko:</strong> ${yearData.rata_rata_risiko}<br>
                        <strong>⚠️ Tingkat Risiko:</strong> <span style="color: ${riskColor}; font-weight: bold; font-size: 1.1em;">${yearData.tingkat_risiko}</span><br>
                        <strong>🔴 Risiko Tertinggi:</strong> ${yearData.risiko_tertinggi}<br>
                        <strong>📅 Bulan Berisiko:</strong> ${yearData.bulan_berisiko} bulan<br>
                        ${regionInfo.population ? `<strong>👥 Populasi:</strong> ${regionInfo.population}<br>` : ''}
                    </div>
                    <hr style="margin: 8px 0;">
                    <small style="color: #6c757d;">
                        <i class="fas fa-play"></i> Real-time simulation active
                    </small>
                </div>
            `;
            
            if (regionMarker && predictionMap) {
                regionMarker.bindPopup(popupContent);
                // Auto-open popup for real-time feedback
                if (simulationInterval) {
                    regionMarker.openPopup();
                }
            }
            
            // Real-time visual feedback - flash effect
            const infoPanel = $('.year-info-panel');
            infoPanel.css('background-color', riskColor);
            infoPanel.css('opacity', '0.9');
            setTimeout(() => {
                infoPanel.css('background-color', '#f8f9fa');
                infoPanel.css('opacity', '1');
            }, 300);
        }

        function updateYearInfo(yearIndex) {
            if (!simulationData || !simulationData.yearly_summary[yearIndex]) return;
            
            const yearData = simulationData.yearly_summary[yearIndex];
            
            // Real-time updates with smooth animations
            $('#info-year').text(yearData.tahun);
            $('#info-risk').text(yearData.rata_rata_risiko);
            $('#info-status').text(yearData.tingkat_risiko);
            $('#info-risky-months').text(yearData.bulan_berisiko);
            
            // Update status color with real-time feedback
            const statusColors = {
                'Rendah': '#28a745',
                'Sedang': '#fd7e14',
                'Tinggi': '#dc3545'
            };
            
            const statusColor = statusColors[yearData.tingkat_risiko] || '#6c757d';
            $('#info-status').css('color', statusColor);
            
            // Add real-time pulse effect for high risk
            if (yearData.tingkat_risiko === 'Tinggi') {
                $('#info-status').addClass('pulse-animation');
                setTimeout(() => $('#info-status').removeClass('pulse-animation'), 1000);
            }
            
            // Real-time progress indicator
            const progressPercent = ((yearIndex + 1) / simulationData.yearly_summary.length) * 100;
            if (!$('.simulation-progress').length) {
                $('.year-info-panel').append(`
                    <div class="simulation-progress mt-2">
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                `);
            }
            $('.simulation-progress .progress-bar').css('width', progressPercent + '%');
        }

        function startSimulation() {
            if (simulationInterval) return; // Already running
            
            console.log('Starting real-time simulation');
            $('#play-simulation').hide();
            $('#pause-simulation').show();
            
            // Add real-time simulation indicator
            $('body').append(`
                <div id="simulation-indicator" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #dc3545;
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    z-index: 10000;
                    animation: pulse 1s infinite;
                ">
                    🔴 LIVE SIMULATION
                </div>
            `);
            
            // Real-time simulation with smoother intervals
            simulationInterval = setInterval(() => {
                currentYearIndex++;
                
                if (currentYearIndex >= simulationData.yearly_summary.length) {
                    // End of simulation
                    pauseSimulation();
                    currentYearIndex = simulationData.yearly_summary.length - 1;
                    return;
                }
                
                // Real-time updates
                updateMapForYear(currentYearIndex);
                updateYearInfo(currentYearIndex);
                
                // Real-time audio feedback (optional)
                if (simulationData.yearly_summary[currentYearIndex].tingkat_risiko === 'Tinggi') {
                    // Visual alert for high risk
                    $('body').css('background-color', 'rgba(220, 53, 69, 0.1)');
                    setTimeout(() => $('body').css('background-color', ''), 200);
                }
                
            }, 1200); // Faster real-time updates every 1.2 seconds
        }

        function pauseSimulation() {
            console.log('Pausing simulation');
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            $('#play-simulation').show();
            $('#pause-simulation').hide();
            
            // Remove real-time indicator
            $('#simulation-indicator').remove();
            
            // Reset background
            $('body').css('background-color', '');
        }

        function resetSimulation() {
            console.log('Resetting simulation');
            pauseSimulation();
            currentYearIndex = 0;
            
            // Reset to first year with smooth transition
            updateMapForYear(0);
            updateYearInfo(0);
            
            // Reset progress bar
            $('.simulation-progress .progress-bar').css('width', '0%');
            
            // Close any open popups
            if (predictionMap && regionMarker) {
                predictionMap.closePopup();
            }
            
            // Visual feedback for reset
            $('.year-info-panel').css('background-color', '#28a745');
            setTimeout(() => {
                $('.year-info-panel').css('background-color', '#f8f9fa');
            }, 500);
        }

        function displayPredYearlySummary(summaryData) {
            let summaryHtml = '';
            
            summaryData.forEach(year => {
                const riskClass = year.tingkat_risiko.toLowerCase();
                const badgeClass = riskClass === 'tinggi' ? 'danger' : riskClass === 'sedang' ? 'warning' : 'success';
                
                summaryHtml += `
                    <div class="step-content">
                        <div class="row">
                            <div class="col-md-2">
                                <h5>${year.tahun}</h5>
                            </div>
                            <div class="col-md-3">
                                <span class="badge badge-${badgeClass}">
                                    ${year.tingkat_risiko}
                                </span>
                            </div>
                            <div class="col-md-7">
                                <small>
                                    Rata-rata risiko: ${year.rata_rata_risiko} |
                                    Risiko tertinggi: ${year.risiko_tertinggi} |
                                    Bulan berisiko: ${year.bulan_berisiko}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#pred-yearly-summary').html(summaryHtml);
        }

        function displayPredTable(predictions) {
            let tableHtml = '';
            
            predictions.forEach(pred => {
                const riskLabels = {0: 'Aman', 1: 'Waspada', 2: 'Siaga', 3: 'Awas'};
                const riskColors = {0: 'success', 1: 'primary', 2: 'warning', 3: 'danger'};
                const label = riskLabels[pred.prediksi_value] || pred.prediksi_label;
                const color = riskColors[pred.prediksi_value] || 'secondary';
                
                tableHtml += `
                    <tr>
                        <td>${pred.tahun}</td>
                        <td>${pred.bulan}</td>
                        <td>${pred.curah_hujan}</td>
                        <td>${pred.suhu}</td>
                        <td>${pred.tinggi_air}</td>
                        <td>${pred.prediksi_value}</td>
                        <td><span class="badge badge-${color}">${label}</span></td>
                    </tr>
                `;
            });
            
            $('#pred-predictions-table tbody').html(tableHtml);
        }
    </script>
</body>
</html>
